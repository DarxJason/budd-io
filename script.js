export class mainMap extends Phaser.Scene{constructor(){super("mainMap")}preload(){this.load.tilemapTiledJSON("maps","src/assets/map.json"),this.load.image("tiles","src/assets/tiles.png"),this.load.image("player","src/assets/flower.webp"),this.load.image("enemy","src/assets/mob/bee.svg"),this.load.image("yellow_ladybug","src/assets/shineyLadybug.png"),this.load.image("petal","src/assets/petal.png"),this.load.image("squareBud","src/assets/squareBud.png"),this.load.image("bush","src/assets/mob/bush.svg")}create(){let e=this.add.tilemap("maps"),t=e.addTilesetImage("tileset","tiles"),s=e.createLayer("Map",t,0,0),i=e.createLayer("Walls",t,0,0);s.setScale(15),i.setScale(15),this.useMouseControl=!1,this.movementArrow=this.add.graphics(),this.movementArrow.lineStyle(12,8421504),this.player=this.physics.add.sprite(Phaser.Math.Between(4e3,6e3),Phaser.Math.Between(6200,8e3),"player"),this.player.setScale(.3),this.player.setDepth(1),this.player.body.setCircle(.47*this.player.width,.06*this.player.width,.05*this.player.height),this.player.body.setMass(1e4),this.hp=500,this.currentHp=this.hp,this.createHpBar(),this.createPetalSlots(),this.createUtilityIcons(),this.cursors=this.input.keyboard.createCursorKeys(),this.keys=this.input.keyboard.addKeys({w:Phaser.Input.Keyboard.KeyCodes.W,a:Phaser.Input.Keyboard.KeyCodes.A,s:Phaser.Input.Keyboard.KeyCodes.S,d:Phaser.Input.Keyboard.KeyCodes.D}),this.cameras.main.startFollow(this.player),this.cameras.main.setZoom(.85),this.minimap=this.cameras.add(10,10,150,150).setZoom(.05).setName("mini"),this.minimap.startFollow(this.player),this.minimap.setScroll(0,0),this.cameras.main.ignore(this.minimap),i.setCollisionBetween(15,21),this.physics.add.collider(this.player,i),this.enemies=this.physics.add.group(),this.bushes=this.physics.add.group(),this.physics.add.collider(this.player,this.enemies,this.handleCollision,null,this),this.physics.add.collider(this.enemies,this.enemies),this.physics.add.collider(this.enemies,i),this.physics.add.overlap(this.player,this.enemies,this.chasePlayer,null,this),this.physics.add.collider(this.player,this.bushes,this.handleBushCollision,null,this),this.time.addEvent({delay:2e3,callback:this.changeEnemiesDirection,callbackScope:this,loop:!0}),this.time.addEvent({delay:5e3,callback:this.autoHeal,callbackScope:this,loop:!0}),this.time.addEvent({delay:15e3,callback:this.attemptSpawnEnemy,callbackScope:this,loop:!0}),this.time.addEvent({delay:100004,callback:this.attemptSpawnBush,callbackScope:this,loop:!0})}update(){if(Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.K))&&(this.useMouseControl=!this.useMouseControl),this.useMouseControl){let e=this.input.activePointer,t=e.worldX-this.player.x,s=e.worldY-this.player.y,i=Math.atan2(s,t),a=Math.sqrt(t*t+s*s),l=150;if(a>10){a<150&&(l=Math.max(10,a));let r=t/a*l,h=s/a*l;this.player.setVelocity(r,h)}else this.player.setVelocity(0);this.movementArrow.clear(),this.movementArrow.fillStyle(8421504);let o=this.player.x+50*Math.cos(i),n=this.player.y+50*Math.sin(i);this.movementArrow.beginPath(),this.movementArrow.moveTo(o,n),this.movementArrow.lineTo(o-20*Math.cos(i-Math.PI/6),n-20*Math.sin(i-Math.PI/6)),this.movementArrow.lineTo(o-20*Math.cos(i+Math.PI/6),n-20*Math.sin(i+Math.PI/6)),this.movementArrow.closePath(),this.movementArrow.fillPath()}else this.player.setVelocity(0),this.keys.w.isDown||this.cursors.up.isDown?this.player.setVelocityY(-150):(this.keys.s.isDown||this.cursors.down.isDown)&&this.player.setVelocityY(150),this.keys.a.isDown||this.cursors.left.isDown?this.player.setVelocityX(-150):(this.keys.d.isDown||this.cursors.right.isDown)&&this.player.setVelocityX(150),this.movementArrow.clear();this.enemies.getChildren().forEach(e=>{let t;550>Phaser.Math.Distance.Between(this.player.x,this.player.y,e.x,e.y)?this.physics.moveToObject(e,this.player,125):e.setVelocity(50*e.wanderDirection.x,50*e.wanderDirection.y),(0!==e.body.velocity.x||0!==e.body.velocity.y)&&(e.rotation=Math.atan2(e.body.velocity.y,e.body.velocity.x)+Math.PI/2),e.healthBar.clear(),e.healthBar.fillStyle(16711680,1),e.healthBar.fillRect(e.x-20,e.y-35,40,5),e.healthBar.fillStyle(65280,1),e.healthBar.fillRect(e.x-20,e.y-35,40*(e.currentHp/e.maxHp),5),e.rarityText.setPosition(e.x,e.y-50)}),this.updateHpBar(),this.bushes.getChildren().forEach(e=>{e.healthBar.clear(),e.healthBar.fillStyle(16711680,1),e.healthBar.fillRect(e.x-20,e.y-35,40,5),e.healthBar.fillStyle(65280,1),e.healthBar.fillRect(e.x-20,e.y-35,40*(e.currentHp/e.maxHp),5)})}spawnBush(e,t,s){let i=this.physics.add.sprite(e,t,"bush");i.setScale(1),i.setDepth(1);let a=this.getRarityMultiplier(s);i.maxHp=60*a,i.currentHp=i.maxHp,i.healthBar=this.add.graphics(),i.healthBar.setDepth(5),i.rarityText=this.add.text(i.x,i.y-50,s,{fontSize:"25px",fill:"#ffffff"}),i.rarityText.setOrigin(.5),i.rarityText.setDepth(6),i.body.immovable=!0,i.body.moves=!1,i.damageDelt=20*a,this.bushes.add(i),i.healthBar.clear(),i.healthBar.fillStyle(16711680,1),i.healthBar.fillRect(i.x-20,i.y-35,40,5),i.healthBar.fillStyle(65280,1),i.healthBar.fillRect(i.x-20,i.y-35,40*(i.currentHp/i.maxHp),5),i.rarityText.setPosition(i.x,i.y-50)}attemptSpawnBush(){let e=Phaser.Math.Between(4e3,6e3),t=Phaser.Math.Between(6200,8e3);this.spawnBush(e,t,.1>Math.random()?"rare":"common")}handleBushCollision(e,t){this.damageCooldown||(this.takeDamage(t.damageDelt),this.player.setTint(16711680),this.time.delayedCall(100,()=>{this.player.clearTint()}),this.damageCooldown=!0,this.time.delayedCall(500,()=>{this.damageCooldown=!1})),t.damageCooldown||(this.damageBush(t,5),t.setTint(16711680),this.time.delayedCall(100,()=>{t.clearTint()}),t.damageCooldown=!0,this.time.delayedCall(500,()=>{t.damageCooldown=!1}));let s=Phaser.Math.Angle.Between(e.x,e.y,t.x,t.y);e.body.velocity.x+=2e3*Math.cos(s),e.body.velocity.y+=2e3*Math.sin(s)}damageBush(e,t){e.currentHp=Phaser.Math.Clamp(e.currentHp-t,0,e.maxHp),e.currentHp<=0&&this.bushDied(e)}bushDied(e){e.rarityText.destroy(),e.healthBar.destroy(),e.destroy()}autoHeal(){this.currentHp<=this.hp-50&&(this.currentHp+=50)}createHpBar(){this.hpBarContainer=document.createElement("div"),this.hpBarContainer.style.position="absolute",this.hpBarContainer.style.top="20px",this.hpBarContainer.style.right="20px",this.hpBarContainer.style.width="250px",this.hpBarContainer.style.height="30px",this.hpBarContainer.style.borderRadius="30px",this.hpBarContainer.style.backgroundColor="#000",this.hpBarContainer.style.padding="5px",this.hpBarContainer.style.boxSizing="border-box",document.body.appendChild(this.hpBarContainer),this.hpBar=document.createElement("div"),this.hpBar.style.height="100%",this.hpBar.style.width="100%",this.hpBar.style.borderRadius="30px",this.hpBar.style.backgroundColor="#ffe100",this.hpBar.style.boxSizing="border-box",this.hpBarContainer.appendChild(this.hpBar),this.updateHpBar()}createBottomBoxes(){}createPetalSlots(){this.petalSlots=[];let e=document.createElement("div");e.style.position="absolute",e.style.bottom="15px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.maxWidth="100%",document.body.appendChild(e);for(let t=0;t<10;t++){let s=document.createElement("div");s.style.width="43px",s.style.height="43px",s.style.backgroundColor="#f7f3f1",s.style.display="inline-block",s.style.margin="3px 3px",s.style.borderRadius="5px",s.style.border="3px solid #ccc5c0",e.appendChild(s),this.petalSlots.push(s);let i=document.createElement("img");i.style.width="33px",i.src="src/assets/squareBud.png",i.style.padding="5px",i.style.height="33px",i.style.borderRadius="3px",i.style.backgroundColor="black",i.style.cursor="pointer",s.appendChild(i)}}createUtilityIcons(){let e=document.createElement("div");e.style.position="absolute",e.style.bottom="5px",e.style.left="10px",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-start",document.body.appendChild(e),[{BOXborder:"#4981b1",BGcolor:"#5a9fdb",color:"#5a9fdb",border:"4px solid #4981b1",key:"(C)",image:"src/assets/crafting.svg",content:"Crafting"}].forEach((t,s)=>{let i=document.createElement("div");i.style.width="43px",i.style.height="43px",i.style.backgroundColor=t.color,i.style.margin="3px 0",i.style.borderRadius="5px",i.style.border=t.border,i.style.position="relative",i.style.cursor="pointer",e.appendChild(i);let a=document.createElement("img");a.src=t.image,a.style.width="100%",a.style.height="100%",a.style.borderRadius="3px",i.appendChild(a),i.addEventListener("click",()=>{this.scene.start("crafting")});let l=document.createElement("div");l.style.position="absolute",l.style.bottom="100%",l.style.left="50%",l.style.transform="translateX(-50%)",l.style.marginBottom="5px",l.style.padding="5px 10px",l.style.backgroundColor="#000",l.style.color="#fff",l.style.borderRadius="5px",l.style.fontSize="12px",l.style.whiteSpace="nowrap",l.style.visibility="hidden",l.style.opacity="0",l.style.transition="opacity 0.3s",l.innerHTML=`${t.key} ${t.content}`,i.appendChild(l),i.addEventListener("mouseover",()=>{l.style.visibility="visible",l.style.opacity="1"}),i.addEventListener("mouseout",()=>{l.style.visibility="hidden",l.style.opacity="0"});let r=document.createElement("div");r.style.position="absolute",r.style.bottom="0",r.style.right="0",r.style.fontSize="10px",r.style.backgroundColor=t.BGcolor,r.style.color="#fff",r.style.padding="2px 4px",r.style.borderRadius="3px",r.style.border=t.BOXborder,r.innerHTML=t.key,i.appendChild(r)})}updateHpBar(){let e=this.currentHp/this.hp;this.hpBar.style.width=`${100*e}%`}handleCollision(e,t){this.damageCooldown||(this.takeDamage(t.damageDelt),this.player.setTint(16711680),this.time.delayedCall(100,()=>{this.player.clearTint()}),this.damageCooldown=!0,this.time.delayedCall(500,()=>{this.damageCooldown=!1})),t.damageCooldown||(this.damageEnemy(t,5),t.setTint(16711680),this.time.delayedCall(100,()=>{t.clearTint()}),t.damageCooldown=!0,this.time.delayedCall(500,()=>{t.damageCooldown=!1}));let s=Phaser.Math.Angle.Between(e.x,e.y,t.x,t.y);e.body.setVelocity(-(200*Math.cos(s)),-(200*Math.sin(s)))}takeDamage(e){this.currentHp=Phaser.Math.Clamp(this.currentHp-e,0,this.hp),this.smoothHpBarDecrease(),this.currentHp<=0&&this.playerDied()}damageEnemy(e,t){e.currentHp=Phaser.Math.Clamp(e.currentHp-t,0,e.maxHp),e.currentHp<=0&&this.enemyDied(e)}enemyDied(e){e.rarityText.destroy(),e.healthBar.destroy(),e.destroy()}smoothHpBarDecrease(){this.tweens.addCounter({from:this.hpBar.clientWidth,to:this.currentHp/this.hp*250,duration:200,onUpdate:e=>{this.hpBar.style.width=`${e.getValue()}px`}})}playerDied(){this.currentHp=this.hp,this.player.setPosition(Phaser.Math.Between(4e3,6e3),Phaser.Math.Between(6200,8e3)),this.currentHp=this.hp/3,this.smoothHpBarDecrease()}changeDirection(e){let t=[new Phaser.Math.Vector2(1,0),new Phaser.Math.Vector2(-1,0),new Phaser.Math.Vector2(0,1),new Phaser.Math.Vector2(0,-1),new Phaser.Math.Vector2(1,1).normalize(),new Phaser.Math.Vector2(-1,-1).normalize(),new Phaser.Math.Vector2(-1,1).normalize(),new Phaser.Math.Vector2(1,-1).normalize()];e.wanderDirection=Phaser.Utils.Array.GetRandom(t)}changeEnemiesDirection(){this.enemies.getChildren().forEach(e=>{this.changeDirection(e)})}spawnEnemies(e){for(let t=0;t<e;t++){let s=Phaser.Math.Between(4e3,6e3),i=Phaser.Math.Between(6200,8e3),a=Phaser.Math.Between(1,1e3),l,r,h,o,n,$;a<=750?(l="Nob",r="#1b1b1b",h=1.5,o=1,$=1,n=1):a<=975?(l="Mythic",r="#1ce7eb",h=3,o=50,$=20,n=10):a<=999?(l="Ultra",r="#ff0084",h=5,o=1e4,$=100,n=100):(l="Super",r="#00ffb7",h=7,o=1e7,$=250,n=1e3);let d=this.physics.add.sprite(s,i,"enemy");d.setScale(h),d.setDepth(1),d.rarity=l,d.body.setCircle(.3*d.width,.2*d.width,.2*d.height),d.damageMultiplier=$,d.body.setMass(n),d.wanderDirection=new Phaser.Math.Vector2(0,0),this.changeDirection(d),d.healthBar=this.add.graphics(),d.healthBar.setDepth(2),d.currentHp=60*o,d.maxHp=60*o,d.damageDelt=20*$,d.rarityText=this.add.text(d.x,d.y-35,l,{fontSize:"25px",fill:r}),d.rarityText.setOrigin(.5),d.rarityText.setDepth(3),this.enemies.add(d)}}attemptSpawnEnemy(){1===Phaser.Math.Between(1,2)&&this.spawnEnemies(1)}getRarityMultiplier(e){switch(e){case"Nob":default:return 1;case"Mythic":return 5;case"Ultra":return 100;case"Super":return 250}}chasePlayer(e,t){}}let config={type:Phaser.AUTO,width:window.innerWidth,height:window.innerHeight,pixelArt:!0,scene:mainMap,physics:{default:"arcade",arcade:{fps:60,debug:!1}}},game=new Phaser.Game(config);export default mainMap;
